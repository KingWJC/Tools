### 更新DML

#### DML：数据库操作语言

1. 增：一种是元组值的插入，一种是查询结果的插入。

   插入时，省略的列必须满足下面的条件：
   1.该列定义为允许Null值。
   2.在表定义中给出默认值，这表示如果不给出值，将使用默认值

2. 删：从基本表中删除满足条件表达式的元组

   使用truncate table 语句，删除所有行，但是速度更快（没有事务）

3. 改：修改基本表中元组的某些列

### 事务

#### 定义：

事务（Transaction）是一个操作序列。这些操作要么都做，要么都不做，是一个不可分割的工作单位，是数据库环境中的逻辑工作单位。

#### 特点：

1. 保证数据库的完整性、

2. 不能嵌套。

3. 开始：一个Transaction起始于一条DML(Insert、Update和Delete )语句。(oracle中，没有事务开始的语句)

4. Commit表示事务成功地结束

5. Rollback表示事务不成功的结束,数据库应恢复该事务到初始状态.

6. savepoint  保存点：一个操作集合中包含多条SQL语句，但是只想让其中某部分成功

7. 结束：

   – 用户显式执行Commit语句提交操作或Rollback语句回退。
   – 当执行DDL(Create、Alter、Drop)语句事务自动提交。
   – 用户正常断开连接时，Transaction自动提交。
   – 系统崩溃或断电时事务自动回退 。

8. 每次在pl/sql中执行sql语句之后都需要完成commit的操作

#### 事务四大特征：

1. 原子性（Atomicity）
   表示不可分割，一个操作集合要么全部成功，要么全部失败，不可以从中间做切分。
2. 一致性（Consistency）
    一致性代表了底层数据存储的完整性。它必须由事务系统和应用开发人员共同来保证。事务系统通过保证事务的原子性，隔离性和持久性来满足这一要求; 应用开发人员则需要保证数据库有适当的约束(主键，引用完整性等)，并且工作单元中所实现的业务逻辑不会导致数据的不一致(即，数据预期所表达的现实业务情况不相一致)。例如，在一次转账过程中，从某一账户中扣除的金额必须与另一账户中存入的金额相等。支付宝账号100 你读到余额要取，有人向你转100 但是事物没提交（这时候你读到的余额应该是100，而不是200）
3. 隔离性（Isolation）
   各个事务之间相关不会产生影响，（隔离级别：  读未提交，读已提交，可重复读，序列化）。
4. 持久性（Durability）
   所有数据的修改都必须要持久化到存储介质中，不会因为应用程序的关闭而导致数据丢失。

所有的特性中都是为了保证数据的一致性，所以一致性是最终的追求和关键，

并发访问的同时带来的就是数据的不安全，也就是不一致。要保证数据的安全，最主要的方式就是加锁的方式，MVCC。

加锁的同时需要考虑《粒度》的问题：操作的对象：数据库，表，行。一般情况下，锁的粒度越小，效率越高，粒度越大，效率越低 ，在实际的工作环境中，大部分的操作都是行级锁

#### 事务数据的状态

1. 提交或回滚前： 以前的数据可恢复，只有当前的用户可以看到DML操作的结果，被操作的数据被锁住,其他用户不能修改这些数据。
2. 提交后；数据的修改被永久写在数据库中.，数据以前的状态永久性丢失.，所有的用户都能看到操作后的结果.
   ，记录锁被释放,其他用户可操作这些记录.
3. 回滚后：语句将放弃所有的数据修改，修改的数据被回退.，恢复数据以前的状态，行级锁被释放.

#### 事务的隔离性（Isolation）

隔离性是指，多个用户的并发事务访问同一个数据库时，一个用户的事务不应该被其他用户的事务干扰，多个并发事务之间要相互隔离。

数据库隔离级别：

1.读未提交（Read uncommitted）：

这种事务隔离级别下，select语句不加锁。

此时，可能读取到不一致的数据，即“读脏 ”。这是并发最高，一致性最差的隔离级别。

    2.读已提交（Read committed）：

可避免 脏读 的发生。

在互联网大数据量，高并发量的场景下，几乎 不会使用 上述两种隔离级别。

    3.可重复读（Repeatable read）：

可避免 脏读 、不可重复读 的发生。

    4.串行化（Serializable ）：

可避免 脏读、不可重复读、幻读 的发生。

在 ***Oracle数据库*** 中，只支持***Serializable (串行化)*** 级别和 ***Read committed (读已提交)*** 这两种级别，其中默认的为 ***Read committed（读已提交）*** 级别。

#### 事务的延申：

最基本的数据库事务：声明式事务，分布式事务
为了提高效率，有可能多个操作会在同一个事务中执行，那么就有可能部分成功，部分失败，基于这样的情况就需要事务的控制。
select * from emp where id = 7902 for update
select * from emp where id = 7902 lock in share mode.



